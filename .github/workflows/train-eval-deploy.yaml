name: Nizami-1.7B-LLMOps

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  HF_TOKEN:        ${{ secrets.HF_TOKEN }}
  WANDB_API_KEY:   ${{ secrets.WANDB_API_KEY }}
  KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
  KAGGLE_KEY:      ${{ secrets.KAGGLE_KEY }}
  MODEL_ID:        Rustamshry/Qwen3-CoT

jobs:
  train-on-kaggle:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Kaggle API
        run: pip install kaggle

      - name: Push & trigger Kaggle notebook
        run: python kaggle/push_notebook.py

      - name: Wait until kernel finishes
        run: |
          pip install kaggle
          python -c "
          import os, time, kaggle
          kaggle.api.authenticate()
          slug = os.environ['KAGGLE_USERNAME'] + '/nizami-1-7b-cot-train'
          while True:
              status = kaggle.api.kernels_status(slug).status
              status_str = status.value 
              print('Kernel status:', status_str)
              if status_str in [2, 3, 4]: 
                  break
              time.sleep(30)
          if status_str != 2: exit(1)
          "

  evaluate:
    needs: train-on-kaggle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with: {python-version: '3.10'}
        
      - name: Install Kaggle API
        run: pip install kaggle

      - name: Download model from Kaggle Dataset
        run: |
          mkdir -p ./outputs
          kaggle datasets download -d rustamshiriyev/nizami-model-output --unzip -p ./outputs
          # Dataset ZIP içinde klasör yapısı düzeltme
          if [ -d "./outputs/nizami-model-output" ]; then
            mv ./outputs/nizami-model-output/outputs/* ./outputs/ 2>/dev/null || true
            rmdir ./outputs/nizami-model-output/outputs 2>/dev/null || true
            rmdir ./outputs/nizami-model-output 2>/dev/null || true
          fi
          # Veya doğrudan outputs varsa:
          if [ ! -f "./outputs/adapter_config.json" ]; then
            echo "  WARNING: ./outputs may be empty or malformed"
          fi
      - run: pip install -r docker/requirements.txt
      - run: python src/evaluate_llm.py
      - uses: actions/upload-artifact@v4
        with:
          name: metrics
          path: metrics.json
      - uses: actions/upload-artifact@v4
        with:
          name: model-adapter
          path: ./outputs   

  push-hub:
    needs: evaluate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with: {python-version: '3.10'}
      - uses: actions/download-artifact@v4
        with:
          name: model-adapter
          path: ./outputs
      - uses: actions/download-artifact@v4
        with:
          name: metrics
          path: metrics.json
      - run: pip install -r docker/requirements.txt
      - run: python scripts/upload_model.py

  docker-build:
    needs: push-hub
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: pip install -r docker/requirements-serving.txt
      - run: docker build -t nizami-1.7b:latest -f docker/Dockerfile .
