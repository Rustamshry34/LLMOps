name: Nizami-1.7B-LLMOps

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  HF_TOKEN:        ${{ secrets.HF_TOKEN }}
  WANDB_API_KEY:   ${{ secrets.WANDB_API_KEY }}
  KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
  KAGGLE_KEY:      ${{ secrets.KAGGLE_KEY }}
  MODEL_ID:        Rustamshry/Qwen3-CoT

jobs:
  train-on-kaggle:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Kaggle API
        run: pip install kaggle

      - name: Push & trigger Kaggle notebook
        run: python kaggle/push_notebook.py

      - name: Wait until kernel finishes
        run: |
          pip install kaggle
          python -c "
          import os, time, kaggle
          kaggle.api.authenticate()
          slug = os.environ['KAGGLE_USERNAME'] + '/nizami-1-7b-cot-train'
          while True:
              status = kaggle.api.kernels_status(slug).status
              print('Kernel status:', status)
              if status in ['complete', 'error', 'failed']: break
              time.sleep(30)
          if status != 'complete': exit(1)
          "

  evaluate:
    needs: train-on-kaggle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with: {python-version: '3.10'}
      - run: pip install -r docker/requirements.txt
      - run: python src/evaluate.py
      - uses: actions/upload-artifact@v3
        with:
          name: metrics
          path: metrics.json

  push-hub:
    needs: evaluate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with: {python-version: '3.10'}
      - run: pip install -r docker/requirements.txt
      - run: python scripts/upload_model.py

  docker-build:
    needs: push-hub
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: docker build -t nizami-1.7b:latest -f docker/Dockerfile .
